name: Build & Deploy Release

on:
  push:
    tags:
      - 'v*'

env:
  FLUTTER_VERSION: '3.38.x'

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
      build_number: ${{ steps.extract.outputs.build_number }}
    steps:
      - name: Extract version from tag
        id: extract
        run: |
          TAG="${GITHUB_REF#refs/tags/v}"
          # Tag format: v{major}.{minor}.{patch}+{build_number}
          if [[ "$TAG" == *"+"* ]]; then
            VERSION="${TAG%%+*}"
            BUILD_NUMBER="${TAG##*+}"
          else
            VERSION="$TAG"
            BUILD_NUMBER="${{ github.run_number }}"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "build_number=$BUILD_NUMBER" >> "$GITHUB_OUTPUT"
          echo "Version: $VERSION, Build: $BUILD_NUMBER"

  deploy-android:
    needs: version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Generate l10n
        run: flutter gen-l10n

      - name: Create .env.production
        run: |
          printf '%s\n' \
            "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" \
            "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" \
            "APP_ENV=production" \
            > .env.production

      - name: Decode keystore
        run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks

      - name: Create key.properties
        run: |
          printf '%s\n' \
            "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" \
            "keyPassword=${{ secrets.KEY_PASSWORD }}" \
            "keyAlias=${{ secrets.KEY_ALIAS }}" \
            "storeFile=../app/upload-keystore.jks" \
            > android/key.properties

      - name: Build AAB
        run: |
          flutter build appbundle --release \
            --build-name=${{ needs.version.outputs.version }} \
            --build-number=${{ needs.version.outputs.build_number }} \
            --dart-define=ENV_FILE=.env.production

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Deploy to Play Store (internal)
        run: |
          echo '${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON }}' > android/play-store-service-account.json
          cd android && bundle exec fastlane internal
        env:
          PLAY_STORE_JSON_KEY_FILE: play-store-service-account.json

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: build/app/outputs/bundle/release/app-release.aab

      - name: Cleanup secrets
        if: always()
        run: |
          rm -f android/app/upload-keystore.jks
          rm -f android/key.properties
          rm -f android/play-store-service-account.json
          rm -f .env.production

  deploy-ios:
    needs: version
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Generate l10n
        run: flutter gen-l10n

      - name: Create .env.production
        run: |
          printf '%s\n' \
            "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" \
            "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" \
            "APP_ENV=production" \
            > .env.production

      - name: Install CocoaPods
        run: cd ios && pod install

      - name: Setup SSH for match
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.MATCH_GIT_PRIVATE_KEY }}

      - name: Build iOS (no-codesign)
        run: |
          flutter build ios --release --no-codesign \
            --build-name=${{ needs.version.outputs.version }} \
            --build-number=${{ needs.version.outputs.build_number }} \
            --dart-define=ENV_FILE=.env.production

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Deploy to TestFlight
        run: cd ios && bundle exec fastlane beta
        env:
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: Cleanup secrets
        if: always()
        run: rm -f .env.production

  github-release:
    needs: [version, deploy-android, deploy-ios]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download AAB
        uses: actions/download-artifact@v4
        with:
          name: android-aab
          path: artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "Zan v${{ needs.version.outputs.version }} (${{ needs.version.outputs.build_number }})"
          draft: false
          prerelease: ${{ contains(github.ref_name, '-rc') || contains(github.ref_name, '-beta') }}
          files: artifacts/app-release.aab
          generate_release_notes: true
